% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit_mfp.R
\name{fit_mfp}
\alias{fit_mfp}
\title{Function for fitting a model using the MFP, MFPA or spike-at-zero algorithm}
\usage{
fit_mfp(
  x,
  y,
  weights,
  offset,
  cycles,
  scale,
  shift,
  df,
  center,
  family,
  criterion,
  select,
  alpha,
  keep,
  xorder,
  powers,
  method,
  strata,
  nocenter,
  acdx,
  ftest,
  control,
  zero,
  catzero,
  spike,
  verbose
)
}
\arguments{
\item{x}{an input matrix of dimensions nobs x nvars. Does not contain
intercept, but columns are already expanded into dummy variables as
necessary. Data are assumed to be shifted and scaled.}

\item{y}{a vector for the response variable or a \code{Surv} object.}

\item{weights}{a vector of observation weights of length nobs.}

\item{offset}{a vector of length nobs of offsets.}

\item{cycles}{an integer representing the maximum number of
iteration cycles during which FP powers for all predictor are updated.}

\item{scale}{a numeric vector of length nvars of scaling factors. Not applied,
but re-ordered to conform to \code{xorder}.}

\item{shift}{a numeric vector of length nvars of shifts. Not applied,
but re-ordered to conform to \code{xorder}.}

\item{df}{a numeric vector of length nvars of degrees of freedom.}

\item{center}{a logical vector of length nvars indicating if variables are
to be centered.}

\item{family}{a character string representing a family object.}

\item{criterion}{a character string defining the criterion used to select
variables and FP models of different degrees.}

\item{select}{a numeric vector of length nvars indicating significance levels
for backward elimination.}

\item{alpha}{a numeric vector of length nvars indicating significance levels
for tests between FP models of different degrees.}

\item{keep}{a character vector with names of variables to be kept
in the model.}

\item{xorder}{a string determining the order of entry of the covariates
into the model-selection algorithm.}

\item{powers}{a named list of numeric values that sets the permitted FP
powers for each covariate.}

\item{method}{a character string specifying the method for tie handling in
Cox regression model.}

\item{strata}{a factor of all possible combinations of stratification
variables. Returned from \code{\link[survival:strata]{survival::strata()}}.}

\item{nocenter}{a numeric vector with a list of values for fitting Cox
models. See \code{\link[survival:coxph]{survival::coxph()}} for details.}

\item{acdx}{a logical vector of length nvars indicating which continuous
variables should undergo the approximate cumulative distribution (ACD)
transformation.}

\item{ftest}{a logical indicating the use of the F-test for Gaussian models.}

\item{control}{a list with parameters for model fit. See \code{\link[survival:coxph]{survival::coxph()}}
or \code{\link[stats:glm]{stats::glm()}} for details.}

\item{zero}{A logical vector indicating, by position, which columns of
\code{x} should treat nonpositive values (zero or negative) as zero before
transformation. Must be the same length and in the same order as the columns
of \code{x}.}

\item{catzero}{A logical vector similar to \code{zero}, indicating which
columns of \code{x} should treat nonpositive values as zero and also have a binary
indicator automatically created and included in the model. Must match the length
and order of the columns in \code{x}. See \code{\link{mfp2}} for details.}

\item{spike}{A logical vector indicating which columns of \code{x} contain
a spike at zero. The length and order of \code{spike} must match those of
the columns in \code{x}.}

\item{verbose}{Logical; if \code{TRUE}, additional information will be printed
during model fitting steps. Useful for understanding internal processing.
Default is \code{FALSE}.}
}
\value{
See \code{\link[=mfp2]{mfp2()}} for details on the returned object.
}
\description{
This internal function implements the Multivariable Fractional Polynomial (MFP),
MFP with Approximate Cumulative Distribution (MFPA), and spike-at-zero (SAZ)
algorithms. It is not exported and is intended to be called from \code{\link[=mfp2]{mfp2()}}.
While most parameters are documented in \code{mfp2()}, their form may differ here.
The function does not perform argument checks and expects that all inputs
have been properly prepared by \code{mfp2()}.
}
\section{Algorithm}{

\itemize{
\item Step 1: variable ordering. Variables are ordered according to \code{xorder}. This
may involve fitting a regression model to determine entry order.
\item Step 2 preprocessing: Initial powers for fractional  polynomial terms are
set, checking if acd transformation is required and allowed, and
zero and catzero variables are handled, spike variables are marked.
Note that the initial powers of all variables are always set to 1, and higher
FPs are only evaluated in turn for each variables in the first cycle of the
algorithm. See e.g. Sauerbrei and Royston (1999).
\item Step 3: MFP cycles.Iteratively updates FP powers and spike decisions using
\code{find_best_fp_cycle()} until convergence or maximum cycles are reached.
During cycles, \code{prev_adj_params} stores previously computed transformations
for adjustment variables to avoid recomputation. It is updated at the end of
each cycle and reused in the next.
\item Step 4: Final transformation. Applies final FP powers to \code{x}, generates
binary variables for catzero, handles centering, and applies backscaling if
required.
\item Step 5: Model fitting. Fits the final model using the transformed \code{x} and
returns an \code{mfp2} object with transformed data, centers, FP powers,
acd parameters, and convergence information.
}
}

\references{
Sauerbrei, W. and Royston, P. (1999). Building multivariable prognostic
and diagnostic models: transformation of the predictors by using fractional
polynomials. \emph{Journal of the Royal Statistical Society: Series A (Statistics in Society)}, 162, 71–94.

Royston, P. and Sauerbrei, W. (2016). mfpa: Extension of mfp using the ACD covariate
transformation for enhanced parametric multivariable modeling. \emph{The Stata Journal},
16(1), 72–87.

Lorenz, E., Jenkner, C., Sauerbrei, W., and Becher, H. (2017). Modeling variables
with a spike at zero: examples and practical recommendations. \emph{American Journal of Epidemiology},
185(8), 650–660.

Lorenz, E., Jenkner, C., Sauerbrei, W., and Becher, H. (2019). Modeling exposures
with a spike at zero: simulation study and practical application to survival data.
\emph{Biostatistics & Epidemiology}, 3(1), 23–37.
}
\seealso{
\code{\link[=mfp2]{mfp2()}}, \code{\link[=find_best_fp_cycle]{find_best_fp_cycle()}}
}
