% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/mfp_step.R
\name{transform_data_step}
\alias{transform_data_step}
\title{Function to extract and transform adjustment variables}
\usage{
transform_data_step(
  x,
  xi,
  powers_current,
  df,
  powers,
  acdx,
  zero,
  catzero,
  spike_decision,
  acd_parameter,
  prev_adj_params
)
}
\arguments{
\item{x}{a matrix of predictors that includes the variable of interest \code{xi}.
It is assumed that continuous variables have already been shifted and scaled.}

\item{xi}{name of the continuous predictor for which the FP function will be
estimated. There are no binary or two-level variables allowed. All variables
except \code{xi} are referred to as "adjustment variables".}

\item{powers_current}{a named list of FP powers of all variables of interest,
including \code{xi}. Note that these powers are updated during backfitting or MFP
cycles.}

\item{df}{a numeric vector of degrees of freedom for \code{xi}.}

\item{powers}{a set of allowed FP powers.}

\item{acdx}{a logical vector indicating the use of acd transformation.}

\item{zero}{named logical vector of length ncol(x)}

\item{catzero}{A named list of binary indicator variables of length \code{ncol(x)}
for nonpositive values, created when specific variables are passed to the
\code{catzero} argument of \code{fit_mfp}. If an element of the list is
\code{NULL}, it indicates that the corresponding variable was not specified by
the user in the \code{catzero} argument of \code{fit_mfp}. Here, \code{catzero}
is a list of binary variables, not a named logical vector as in \code{fit_mfp}.}

\item{spike_decision}{a named numeric vector with the same names as the
\code{x} matrix. Each element controls how the corresponding adjustment
variable contributes to the adjustment matrix:
\itemize{
\item \code{1}: combine both the transformed adjustment variable and its binary
indicator (\code{catzero}).
\item \code{2}: include only the transformed adjustment variable.
\item \code{3}: include only the binary indicator (\code{catzero}).
This applies only to adjustment variables, not the focal predictor \code{xi}.
}}

\item{acd_parameter}{Named list of ACD parameters produced by \code{fit_acd()},
with length equal to \code{ncol(x)}.}

\item{prev_adj_params}{Named list containing results from a previous call to
this function. Used to avoid recomputing adjustment variables if both powers
and \code{spike_decision} remain unchanged for a certain variable.}
}
\value{
A list containing \code{power_best} (numeric vector of best FP powers for \code{xi},
possibly including \code{NA}), \code{spike_decision} (updated spike-at-zero strategy),
and \code{current_adj_params} (adjustment variable transformations used in this step).
\item{powers_fp}{Numeric vector of FP powers used for \code{xi}.}
\item{data_fp}{List of transformed data for \code{xi}.}
\item{powers_adj}{Named list of FP powers used for adjustment variables.}
\item{data_adj}{Matrix of transformed adjustment variables, or \code{NULL} if none.}
\item{current_params}{Named list containing adjustment variable parameters
for reuse in later steps, including \code{powers_adj},
\code{spike_decision_adj}, \code{data_adj_list}, and \code{data_adj}.}
}
\description{
This function prepares transformed data for a focal predictor \code{xi} and its
adjustment variables. Adjustment variables are transformed using either
fractional polynomials or acd transformations, depending on their assigned
powers and parameters. Spike-at-zero effects can be incorporated using
binary indicators. Previously computed adjustment variables can be reused
if their parameters have not changed.
}
\details{
This function extracts the adjustment variables and applies the corresponding
FP or ACD transformations based on \code{powers_current}. When evaluating the variable
of interest \code{xi}, it is necessary to account for other variables in the model,
which may be transformed or untransformed depending on their individual powers.
Some powers may be \code{NA}, indicating that the corresponding variable has been
excluded from the adjustment set.

To improve efficiency, the function avoids recomputing adjustment variables if
their parameters (\code{powers} and \code{spike_decision}) have not changed from a
previous step, as provided in \code{prev_adj_params}.

The role of \code{spike_decision} is to determine how each adjustment variable is
represented in the presence of potential spike-at-zero effects. For every
adjustment variable, the function can include the transformed variable, the
binary indicator for nonpositive values (\code{catzero}), or both. This makes it
possible to model spike-at-zero behavior directly in the adjustment matrix,
while preserving flexibility in how variables are included.

The function also returns the FP data for predictor \code{xi} of interest, which
depends on the specified degrees of freedom. For example,
\code{df = 2} is equivalent to FP degree one, resulting in the generation of 8
variables. If \code{acdx} for the current variables of interest is set to \code{TRUE},
however, 64 variables are generated.

When \code{df = 1}, this function returns data unchanged, i.e. a "linear"
transformation with power equal to 1. In case \code{acdx[xi] = TRUE}, the
acd transformation is applied.
}
\keyword{internal}
